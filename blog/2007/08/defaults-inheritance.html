<!DOCTYPE html>
<html lang="en">
<head>
        <title>Defaults & Inheritance</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
          <link rel="stylesheet" href="https://ianbicking.org/theme/css/style.min.css">
        <!--<link rel="stylesheet" href="https://ianbicking.org/theme/css/main.css" type="text/css" />-->
        <link href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Ian Bicking: a blog Atom Feed" />
        <link rel="icon" href="https://ianbicking.org/favicon.ico">

</head>

<body id="index" class="home">
  <div id="main-wrapper1">
  <div id="main-wrapper2">
  <div id="main-container">
        <header id="banner" class="body">
                <h1><a href="https://ianbicking.org">Ian Bicking: a blog </a></h1>
        </header><!-- /#banner -->
<section id="content" class="body">
    <article>
        <header>
        <div>
            <div class="published" title="2007-08-10T17:45:00-05:00">
                Friday, August 10th, 2007
            </div>
            <h1 class="entry-title">
                <a
                    href="https://ianbicking.org/blog/2007/08/defaults-inheritance.html"
                    rel="bookmark"
                    title="Permalink to Defaults & Inheritance"
                    >Defaults <span class="amp">&amp;</span>&nbsp;Inheritance</a
                >
            </h1>
        </div>
        </header>

        <div class="entry-content"><p>I thought I&#8217;d note a way I try to make classes reasonably customizable without creating lots of classes, but letting other people create classes if they&nbsp;want.</p>
<p>Here&#8217;s a common technique; I&#8217;m going to use a class from <a class="reference external" href="http://pythonpaste.org/wsgiproxy/">WSGIProxy</a> as an example, because that&#8217;s where I was about to use this technique when I thought it might make an okay&nbsp;post.</p>
<p>In this example there&#8217;s a <span class="caps">WSGI</span> application that forwards requests to another <span class="caps">HTTP</span> server.  There&#8217;s different ways to forward requests, depending on what kind of data you want to give the remote server about the original request.  One example is Zope&#8217;s VirtualHostMonster, which takes requests like <tt class="docutils literal">/VirtualHostBase/http/example.org:80/rootdir/VirtualHostBase/path</tt> &#8212; the idea is that the server can then realize that the original request was for <tt class="docutils literal"><span class="pre">http://example.org/path</span></tt> (and should ignore any Host headers), and that Zope is supposed to serve that from the internal path <tt class="docutils literal">/rootdir/path</tt>.</p>
<p>There&#8217;s a problem with this particular pattern, because there&#8217;s no way to mount, say, <tt class="docutils literal">/blog</tt> onto some Zope <tt class="docutils literal"><span class="pre">/sitename/blog-application</span></tt> path, because there&#8217;s no concept like in <span class="caps">WSGI</span> or <span class="caps">CGI</span> of SCRIPT_NAME &#8212; the base <em>path</em> of the request.  It only handles the base <em>host</em>.  So I didn&#8217;t just want to settle on&nbsp;that.</p>
<p>I&#8217;m kind of inclined to prefer headers, like <tt class="docutils literal"><span class="pre">X-Script-Name:</span> /blog</tt>, <tt class="docutils literal"><span class="pre">X-Forwarded-Server:</span> example.org</tt>, etc.  But I want to support both&nbsp;forms.</p>
<p>The common way to do this&nbsp;is:</p>
<pre class="literal-block">
class WSGIProxyApp(object):

    def __init__(self, host): ...

    def __call__(self, environ, start_response):
        # actual application interface...
        # Constructs the base request:
        request = self.construct_request(environ)
        # Uses one of these conventions:
        self.update_headers(environ, request)
        ... do stuff with request ...

    def update_headers(self, orig_environ, request):
        raise NotImplementedError

class VirtualHostMonsterApp(WSGIProxyApp):

    def update_headers(self, orig_environ, request):
        request.environ['SCRIPT_NAME'] = (
            '/VirtualHostRoot/%(wsgi.scheme)s/%(HTTP_HOST)s/VirtualHostRoot/'
            % orig_environ)

class HeaderSetterApp(WSGIProxyApp):

    def update_headers(self, orig_environ, request):
        request.environ['HTTP_X_SCRIPT_NAME'] = orig_environ['SCRIPT_NAME']
        # and so on...
</pre>
<p>Then you use one of the subclasses depending on your needs. Personally I think this really sucks.  For one thing, you may have to determine which class to use based on some configuration parameter, which can get awkward.  And you might want to subclass the class to change the functionality some yourself, but you have to subclass <em>both</em> of them.  There&#8217;s patterns to handle this, with policies and factories and other crap; but it&#8217;s <em>not a hard problem</em>, and those patterns are hard solutions to a problem that <em>shouldn&#8217;t</em> be&nbsp;hard.</p>
<p>Also, it&#8217;s harder to inform people about the options available to them, and somewhat harder to use these classes.  So I tend to do something&nbsp;like:</p>
<pre class="literal-block">
class WSGIProxyApp(object):
    default_forwarding_style = 'headers'

    def __init__(self, host, forwarding_style=None):
        ...
        if forwarding_style is None:
            forwarding_style = self.default_forwarding_style
        self.forwarding_style = forwarding_style

    def __call__(self, environ, start_response):
        ...
        method = self.forwarding_style
        if isinstance(method, str):
            method = getattr(self, 'forward_'+self.forwarding_style)
        method(environ, request)
        ...

    def forward_headers(self, orig_environ, request): ...
    def forward_virtual_host_monster(self, orig_environ, request): ...
</pre>
<p>This way it&#8217;s just a simple parameter to change the style.  You can pass in your own function, or use one of the named methods already available.  The <tt class="docutils literal">default_forwarding_style</tt> class variable lets you change the default in subclasses.  If the default was in the function signature it would be much more awkard to change it, because you&#8217;d have to override the method and its signature with just that one change, then delegate back to the superclass&nbsp;method.</p>
</div>
        <!-- /.entry-content -->
      </article>
</section>
        <section id="extras" class="body">
                <div class="links">
                  <h2><a href="https://ianbicking.org">here</a></h2>
                  <ul>
                    <li><a href="/blog/">blog</a></li>
                    <li><a href="/projects.html">projects</a></li>
                    <li><a href="https://ianbicking.org/archives.html">archives</a> &amp; <a href="https://ianbicking.org/categories.html">categories</a></li>
                    <li><a href="https://ianbicking.org/category/ai.html">category: ai</a></li>
                    <li><a href="https://ianbicking.org/category/javascript.html">category: javascript</a></li>
                    <li><a href="https://ianbicking.org/category/misc.html">category: misc</a></li>
                    <li><a href="https://ianbicking.org/category/mozilla.html">category: mozilla</a></li>
                    </ul>
                </div>
                <div class="social">
                        <h2>elsewhere</h2>
                        <ul>
                            <li><a href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://hachyderm.io/@ianbicking">@ianbicking@hachyderm.io</a></li>
                            <li><a href="https://github.com/ianb">Github</a></li>
                            <li><a href="https://www.linkedin.com/in/ianbicking/">LinkedIn</a></li>
                            <li><a href="https://twitter.com/ianbicking">@ianbicking</a></li>
                        </ul>
                </div><!-- /.social -->
                <div class="archives">
                  <h2><a href="https://ianbicking.org/blog/">recent posts</a></h2>
                  <ul>
                    <li><a href="https://ianbicking.org/blog/2024/05/ai-aita.html"><span class="caps">AI</span> <span class="caps">AITA</span></a></li>
                    <li><a href="https://ianbicking.org/blog/2024/04/roleplaying-by-llm.html">Roleplaying driven by an <span class="caps">LLM</span>: observations <span class="amp">&amp;</span> open&nbsp;questions</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/04/world-building-gpt-2-declarative.html">World Building with <span class="caps">GPT</span> part 2: bigger, better, more&nbsp;declarative</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/02/world-building-with-gpt.html">World Building With <span class="caps">GPT</span></a></li>
                    <li><a href="https://ianbicking.org/blog/2023/01/thoughts-on-voice-interfaces-2-llms.html">Thoughts On Voice Interfaces 2 years later:&nbsp;LLMs</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/01/infinite-ai-array.html">Infinite <span class="caps">AI</span>&nbsp;Array</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/11/firefox-was-always-enough.html">Firefox Was Always&nbsp;Enough</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/project-ideas-2020.html">Project ideas for (what&#8217;s left of)&nbsp;2020</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/a-history-of-projects.html">A History Of&nbsp;Projects</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/08/thoughts-on-voice-interfaces.html">Thoughts on Voice&nbsp;Interfaces</a></li>
                  </ul>
                </div><!-- /.archives -->

        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
          This is the personal site of <a href="/">Ian Bicking</a>.  The opinions expressed here are my own.
        </footer><!-- /#contentinfo -->

<script src="/theme/instantclick.min.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FKT4HDGBE4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FKT4HDGBE4');
</script>
        </div><!-- /#main-container -->
        </div><!-- /#main-wrapper2 -->
        </div><!-- /#main-wrapper1 -->
</body>
</html>