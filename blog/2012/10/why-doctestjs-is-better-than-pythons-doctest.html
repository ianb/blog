<!DOCTYPE html>
<html lang="en">
<head>
        <title>Why doctest.js is better than Python’s doctest</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
          <link rel="stylesheet" href="https://ianbicking.org/theme/css/style.min.css">
        <!--<link rel="stylesheet" href="https://ianbicking.org/theme/css/main.css" type="text/css" />-->
        <link href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Ian Bicking: a blog Atom Feed" />
        <link rel="icon" href="https://ianbicking.org/favicon.ico">

</head>

<body id="index" class="home">
  <div id="main-wrapper1">
  <div id="main-wrapper2">
  <div id="main-container">
        <header id="banner" class="body">
                <h1><a href="https://ianbicking.org">Ian Bicking: a blog </a></h1>
        </header><!-- /#banner -->
<section id="content" class="body">
    <article>
        <header>
        <div>
            <div class="published" title="2012-10-02T21:26:00-05:00">
                Tuesday, October 2nd, 2012
            </div>
            <h1 class="entry-title">
                <a
                    href="https://ianbicking.org/blog/2012/10/why-doctestjs-is-better-than-pythons-doctest.html"
                    rel="bookmark"
                    title="Permalink to Why doctest.js is better than Python’s doctest"
                    >Why doctest.js is better than Python&#8217;s&nbsp;doctest</a
                >
            </h1>
        </div>
        </header>

        <div class="entry-content"><p>I&#8217;ve been trying, not too successfully I&#8217;m afraid, to get more people to use <a class="reference external" href="http://doctestjs.org">doctest.js</a>.  There&#8217;s probably a few reasons people don&#8217;t.  They are all wrong!  Doctest.js is the&nbsp;best!</p>
<p>One issue in particular is that people (especially people in my Python-biased circles) are perhaps thrown off by Python&#8217;s doctest.  I think Python&#8217;s doctest is pretty nice, I enjoy testing with it, but there&#8217;s no question that it has a lot of problems.  I&#8217;ve even thought about trying to fix doctest, and even made a repository, but I only really got as far as <a class="reference external" href="https://github.com/ianb/doctest2/issues?direction=desc&amp;sort=created&amp;state=open">creating a list of issues I&#8217;d like to fix</a>. But, like so many before me, I never actually <em>made</em> those fixes. Doctest has, in its life, only really had a single period of improvement (in the time leading to Python 2.4).  That&#8217;s not a recipe for&nbsp;success.</p>
<p>Of course doctest.js takes inspiration from Python&#8217;s doctest, but I wrote it as a real test environment, not for a minimal use case.  In the process I fixed a bunch of issues with doctest, and in places Javascript has also provided helpful&nbsp;usability.</p>
<p>Some&nbsp;issues:</p>
<div class="section" id="doctest-js-output-is-predictable">
<h2>Doctest.js output is&nbsp;predictable</h2>
<p>The classic pitfall of Python&#8217;s doctest is printing a&nbsp;dictionary:</p>
<pre class="literal-block">
&gt;&gt;&gt; print {&quot;one&quot;: 1, &quot;two&quot;: 2}
{'two': 2, 'one': 1}
</pre>
<p>The print order of a dictionary is arbitrary, based on a hash algorithm that can change, or mix things up as items are added or removed.  And to make it worse, the output <em>usually</em> stable, such that you can write tests that unexpectibly fragile.  But there&#8217;s no reason why <tt class="docutils literal">dict.__repr__</tt> <em>must</em> use an arbitrary order.  Personally I take it as a bit of unfortunate&nbsp;laziness.</p>
<p>If doctest had used <tt class="docutils literal">pprint</tt> for all of its printing it would have helped some.  But not enough, because this kind of code is fairly&nbsp;common:</p>
<pre class="literal-block">
def __repr__(self):
    return '&lt;ThisClass attr=%r&gt;' % self.attr
</pre>
<p>and that <tt class="docutils literal">%r</tt> invokes a <tt class="docutils literal">repr()</tt> that cannot be&nbsp;overridden.</p>
<p>In doctest.js I always try to make output predictable.  One reason this is fairly easy is that there&#8217;s nothing like <tt class="docutils literal">repr()</tt> in Javascript, so doctest.js has its own implementation.  It&#8217;s like I started with pprint and no other notion&nbsp;existed.</p>
</div>
<div class="section" id="good-matching">
<h2>Good&nbsp;matching</h2>
<p>In addition to unpredictable output, there&#8217;s also just hard-to-match output.  Output might contain blank lines, for instance, and Python&#8217;s doctest requires a very ugly <tt class="docutils literal">&lt;<span class="caps">BLANKLINE</span>&gt;</tt> token to handle that. Whitespace might not be normalized.  Maybe there&#8217;s boring output. Maybe there&#8217;s just a volatile item like a&nbsp;timestamp.</p>
<p>Doctest.js includes, by default, ellipsis: <tt class="docutils literal">...</tt> matches any length of text.  But it also includes another wildcard, <tt class="docutils literal">?</tt>, which matches just one number or word.  This avoids cases when the use of <tt class="docutils literal">...</tt> swallows up too much when you just wanted to get a single&nbsp;word.</p>
<p>Also doctest.js doesn&#8217;t use <tt class="docutils literal">...</tt> for other purposes.  In Python&#8217;s doctest <tt class="docutils literal"><span class="pre">...`</span></tt> is used for continuation lines, meaning you can&#8217;t just ignore output,&nbsp;like:</p>
<pre class="literal-block">
&gt;&gt;&gt; print who_knows_what_this_returns()
...
</pre>
<p>Or even worse, you can&#8217;t ignore the beginning of an&nbsp;item:</p>
<pre class="literal-block">
&gt;&gt;&gt; print some_request
...
X-Some-Header: foo
...
</pre>
<p>The way I prefer to use doctest.js it doesn&#8217;t have <em>any</em> continuation line symbol (but if there is one, it&#8217;s <tt class="docutils literal">&gt;</tt>).</p>
<p>Also doctest.js normalizes whitespace, normalizes <tt class="docutils literal">&quot;</tt> and <tt class="docutils literal">'</tt>, and just generally tries to be <em>reasonable</em>.</p>
</div>
<div class="section" id="doctest-js-tests-are-plain-javascript">
<h2>Doctest.js tests are plain&nbsp;Javascript</h2>
<p>Not many editors know how to syntax highlight and check doctests, with their <tt class="docutils literal">&gt;&gt;&gt;</tt> in front of each line and so forth.  And the whole thing is tweaky, you need to use a continuation (<tt class="docutils literal">...</tt>) on some lines, and start statements with <tt class="docutils literal">&gt;&gt;&gt;</tt>.  It&#8217;s an awkward way to&nbsp;compose.</p>
<p>Doctest.js started out with the same notion, though with different symbols (<tt class="docutils literal">$</tt> and <tt class="docutils literal">&gt;</tt>).  But recently with the rise of a number of excellent parsers (I used <a class="reference external" href="http://esprima.org/">Esprima</a>) I&#8217;ve moved my own tests to another&nbsp;pattern:</p>
<pre class="literal-block">
print(something())
// =&gt; expected output
</pre>
<p>This is already a fairly common way to write examples.  Like how you may have read pre-Python pseudocode and thought: <em>that looks like Python!</em>: doctest.js looks like example&nbsp;pseudocode.</p>
</div>
<div class="section" id="doctest-js-tests-are-self-describing">
<h2>Doctest.js tests are&nbsp;self-describing</h2>
<p>Python&#8217;s doctest has some options, some <em>important</em> options that effect the semantics of the test, that you can only turn on in the runner.  The most important option is <span class="caps">ELLIPSIS</span>.  Either your test was written to use <span class="caps">ELLIPSIS</span> or it wasn&#8217;t - that a test can&#8217;t self-describe its requirements means that test running is&nbsp;fragile.</p>
<p>I made <a class="reference external" href="http://pypi.python.org/pypi/dtopt">the hackiest package ever</a> to get around this in Python, but it&#8217;s hacky and&nbsp;lame.</p>
</div>
<div class="section" id="exception-handling-isn-t-special">
<h2>Exception handling isn&#8217;t&nbsp;special</h2>
<p>Python&#8217;s doctest treats exceptions differently from other output.  So if you print something before the exception, it is thrown away, never to be seen.  And you can&#8217;t use some of the same matching&nbsp;techniques.</p>
<p>Doctest.js just prints out exceptions, and it&#8217;s matched like anything&nbsp;else.</p>
<p>This particular case is one of several places where it feels like Python&#8217;s doctest is just being obstinate.  Doing it the right way isn&#8217;t harder.  Python&#8217;s doctest makes <em>debugging</em> exception cases really&nbsp;hard.</p>
</div>
<div class="section" id="doctest-js-has-a-concept-of-abort">
<h2>Doctest.js has a concept of&nbsp;&#8220;abort&#8221;</h2>
<p>I&#8217;m actually pretty okay with Python doctest&#8217;s notion that you just run all the tests, even when one fails.  Getting too many failures is a bit of a nuisance, but it&#8217;s not <em>that bad</em>.  But there&#8217;s no way to just give up, and there needs to be.  If you are relying on something to be importable, or some service to be available, there&#8217;s no point in going on with the&nbsp;tests.</p>
<p>Doctest.js lets you call <tt class="docutils literal">Abort()</tt> and further tests are&nbsp;cancelled.</p>
</div>
<div class="section" id="distinguishing-between-debugging-output-and-deliberate-output">
<h2>Distinguishing between debugging output and deliberate&nbsp;output</h2>
<p>Maybe it&#8217;s my own fault for being a programming troglodite, but I use a lot of <tt class="docutils literal">print</tt> for debugging.  This becomes a real problem with Python&#8217;s doctest, as it tracks all that printing and it causes tests to&nbsp;fail.</p>
<p>Javascript has something <em>specifically for</em> printing debugging output: <tt class="docutils literal">console.log()</tt>.  Doctest.js doesn&#8217;t mess with that, it adds a new function <tt class="docutils literal">print()</tt>.  Only stuff that is printed (not logged) is treated as expected output.  It&#8217;s like <tt class="docutils literal">console.log()</tt> goes to stderr and <tt class="docutils literal">print()</tt> goes to&nbsp;stdout.</p>
<p>Doctest.js also forces the developer to print everything they care about.  For better or worse Javascript has many more expressions than Python (including assignments), so looking at the result of an expression isn&#8217;t a good clue for whether you <em>care</em> about the result of an expression.  I&#8217;m not sure this is <em>better</em>, but it&#8217;s part of the&nbsp;difference.</p>
<p>Doctest.js also groups your printed statements according to the example you are in (an example being a block of code and an expected output).  This is much more helpful than watching a giant stream of output go to the console (the browser console or&nbsp;terminal).</p>
</div>
<div class="section" id="doctest-js-handles-async-code">
<h2>Doctest.js handles async&nbsp;code</h2>
<p>This admittedly isn&#8217;t that big a deal for Python, but for Javascript it is a real problem.  Not a problem for doctest.js in particular, but a problem for any Javascript test framework.  You want to test return values, but lots of functions don&#8217;t &#8220;return&#8221;, instead they call some callback or create some kind of promise object, and you have to test for side&nbsp;effects.</p>
<p>Doctest.js I think has a <a class="reference external" href="http://doctestjs.org/tutorial.html#async">really great answer for this</a>, which is not so much to say that Python&#8217;s doctest is so much worse, but in the context of Javascript doctest.js has something really useful and unique.  If callback-driven async code had ever been very popular in Python then this sort of feature would be nice there&nbsp;too.</p>
</div>
<div class="section" id="the-browser-is-a-great-environment">
<h2>The browser is a great&nbsp;environment</h2>
<p>A lot of where doctest.js is much better than Python&#8217;s doctest is simply that it has a much more powerful environment for displaying results.  It can highlight failed or passing tests.  When there&#8217;s a wildcard in expected output, it can show the actual output without adding any particular extra distraction.  It can group console messages with the tests they go with.  It can show <em>both</em> a simple failure message, and a detailed line-by-line comparison.  All these details make it easy to identify what went wrong and fix it.  The browser gives a rich and navigable&nbsp;interface.</p>
<p>I&#8217;d <em>like</em> to get doctest.js working well on Node.js (right now it works, but is not appealing), but I just can&#8217;t bring myself to give up the browser.  I have to figure out a good&nbsp;hybrid.</p>
</div>
<div class="section" id="python-s-doctest-lacks-a-champion">
<h2>Python&#8217;s doctest lacks a&nbsp;champion</h2>
<p>This is ultimately the reason Python&#8217;s doctest has all these problems: no one cares about it, no one feels responsible for it, and no one feels empowered to make improvements to it.  And to make things worse there is a cadre of people that will respond to suggestions with their own criticisms that doctest should never be used beyond its original niche, that it&#8217;s constraints are&nbsp;features.</p>
</div>
<div class="section" id="doctest-is-still-great">
<h2>Doctest is still&nbsp;great</h2>
<p>I&#8217;m ragging on Python&#8217;s doctest only because I love it.  I wish it was better, and I made doctest.js in a way I wish Python&#8217;s doctest was made.  Doctest, and more generally example/expectation oriented code, is a great way to explain things, to make tests readable, to make test-driven development feasible, to create an environment that errs on the side of over-testing instead of under-testing, and to make failures and resolutions symmetric.  It&#8217;s still <a class="reference external" href="https://ianbicking.org/behavior-driven-programming.html">vastly superior to <span class="caps">BDD</span></a>, avoiding all <span class="caps">BDD</span>&#8217;s aping of readability while still embracing the sense of&nbsp;test-as-narrative.</p>
<p>But, more to the point: <a class="reference external" href="http://doctestjs.org">use doctest.js</a>, <a class="reference external" href="http://doctestjs.org/tutorial.html">read the tutorial</a>, or <a class="reference external" href="http://doctestjs.org/try.html">try it in the browser</a>.  I swear, it&#8217;s <em>really nice to use</em>.</p>
</div>
</div>
        <!-- /.entry-content -->
      </article>
</section>
        <section id="extras" class="body">
                <div class="links">
                  <h2><a href="https://ianbicking.org">here</a></h2>
                  <ul>
                    <li><a href="/blog/">blog</a></li>
                    <li><a href="/projects.html">projects</a></li>
                    <li><a href="https://ianbicking.org/archives.html">archives</a> &amp; <a href="https://ianbicking.org/categories.html">categories</a></li>
                    <li><a href="https://ianbicking.org/category/ai.html">category: ai</a></li>
                    <li><a href="https://ianbicking.org/category/javascript.html">category: javascript</a></li>
                    <li><a href="https://ianbicking.org/category/misc.html">category: misc</a></li>
                    <li><a href="https://ianbicking.org/category/mozilla.html">category: mozilla</a></li>
                    </ul>
                </div>
                <div class="social">
                        <h2>elsewhere</h2>
                        <ul>
                            <li><a href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://hachyderm.io/@ianbicking">@ianbicking@hachyderm.io</a></li>
                            <li><a href="https://github.com/ianb">Github</a></li>
                            <li><a href="https://www.linkedin.com/in/ianbicking/">LinkedIn</a></li>
                            <li><a href="https://twitter.com/ianbicking">@ianbicking</a></li>
                        </ul>
                </div><!-- /.social -->
                <div class="archives">
                  <h2><a href="https://ianbicking.org/blog/">recent posts</a></h2>
                  <ul>
                    <li><a href="https://ianbicking.org/blog/2024/04/roleplaying-by-llm.html">Roleplaying driven by an <span class="caps">LLM</span>: observations <span class="amp">&amp;</span> open&nbsp;questions</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/04/world-building-gpt-2-declarative.html">World Building with <span class="caps">GPT</span> part 2: bigger, better, more&nbsp;declarative</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/02/world-building-with-gpt.html">World Building With <span class="caps">GPT</span></a></li>
                    <li><a href="https://ianbicking.org/blog/2023/01/thoughts-on-voice-interfaces-2-llms.html">Thoughts On Voice Interfaces 2 years later:&nbsp;LLMs</a></li>
                    <li><a href="https://ianbicking.org/blog/2023/01/infinite-ai-array.html">Infinite <span class="caps">AI</span>&nbsp;Array</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/11/firefox-was-always-enough.html">Firefox Was Always&nbsp;Enough</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/project-ideas-2020.html">Project ideas for (what&#8217;s left of)&nbsp;2020</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/a-history-of-projects.html">A History Of&nbsp;Projects</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/08/thoughts-on-voice-interfaces.html">Thoughts on Voice&nbsp;Interfaces</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/07/kling-axes-of-politics-technocrats.html">Kling&#8217;s Axes of Politics, and the&nbsp;Technocrats</a></li>
                  </ul>
                </div><!-- /.archives -->

        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
          This is the personal site of <a href="/">Ian Bicking</a>.  The opinions expressed here are my own.
        </footer><!-- /#contentinfo -->

<script src="/theme/instantclick.min.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FKT4HDGBE4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FKT4HDGBE4');
</script>
        </div><!-- /#main-container -->
        </div><!-- /#main-wrapper2 -->
        </div><!-- /#main-wrapper1 -->
</body>
</html>