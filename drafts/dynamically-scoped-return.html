<!DOCTYPE html>
<html lang="en">
<head>
        <title>Dynamically Scoped Return</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
          <link rel="stylesheet" href="https://ianbicking.org/theme/css/style.min.css">
        <!--<link rel="stylesheet" href="https://ianbicking.org/theme/css/main.css" type="text/css" />-->
        <link href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Ian Bicking: a blog Atom Feed" />
        <link rel="icon" href="https://ianbicking.org/favicon.ico">

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://ianbicking.org/css/ie.css"/>
                <script src="https://ianbicking.org/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://ianbicking.org/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
  <div id="main-wrapper1">
  <div id="main-wrapper2">
  <div id="main-container">
        <header id="banner" class="body">
                <h1><a href="https://ianbicking.org">Ian Bicking: a blog </a></h1>
        </header><!-- /#banner -->
<section id="content" class="body">
    <article>
        <header>
            <abbr class="published" title="2019-01-25T00:00:00-06:00">
                Friday, January 25th, 2019
            </abbr>
            <h1 class="entry-title">
                <a
                    href="https://ianbicking.org/drafts/dynamically-scoped-return.html"
                    rel="bookmark"
                    title="Permalink to Dynamically Scoped Return"
                    >Dynamically Scoped&nbsp;Return</a
                >
            </h1>
        </header>

        <div class="entry-content"><p>I&#8217;m a committed <code>print()</code> debugger. I know there are better ways. I generally try to learn good tools to do my work, and yet here I seem unable to improve&nbsp;myself.</p>
<p>But if lots of people are wrong, then there&#8217;s probably <em>something</em> right about the wrong&nbsp;thing.</p>
<h2>Print vs. the <span class="caps">REPL</span></h2>
<p>In a <span class="caps">REPL</span> (Read-Eval-Print-Loop) you can understand some of what is&nbsp;happening:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="nb">print</span><span class="p">(</span><span class="n">my_function</span><span class="p">())</span>
<span class="o">&lt;</span><span class="n">Object</span> <span class="n">foo</span><span class="o">...&gt;</span>
</code></pre></div>

<p>You get to see the return value, but not much else. If <code>my_function()</code> is causing problems, or even if you just want to understand the function, you have to start looking inside the function. You can look at the implementation, call the things it calls and as a result inspect the inner workings of the&nbsp;function.</p>
<p>Another approach is to edit the code itself, add some prints. and re-run everything from the top. You don&#8217;t have to dissect the function, and you get to see loops and all kinds of things happen. This is often more reliable, because you are calling everything the way it was &#8220;meant&#8221; to be&nbsp;called.</p>
<p>This might be very specific to debugging, but I don&#8217;t believe so: I believe this is a larger pattern. And because I don&#8217;t know what it&#8217;s called, I&#8217;ll call it &#8220;dynamically scoped return&nbsp;values&#8221;.</p>
<h2>Dynamically vs. Lexically Scoped&nbsp;Variables</h2>
<p>A long time ago there used to be some questions about <a href="https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scope_vs._dynamic_scope">dynamic vs. lexical scoping</a>, but it was settled that only lexical scope made any sense. But to explain, here&#8217;s something you can write in Logo, which is dynamically&nbsp;scoped:</p>
<div class="highlight"><pre><span></span><code><span class="n">make</span><span class="w"> </span><span class="s">&quot;size 100</span>

<span class="n">to</span><span class="w"> </span><span class="n">square</span><span class="w"></span>
<span class="w">  </span><span class="n">repeat</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="nl">fd</span><span class="w"> </span><span class="p">:</span><span class="n">size</span><span class="w"></span>
<span class="w">    </span><span class="n">rt</span><span class="w"> </span><span class="mi">90</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="n">end</span><span class="w"></span>

<span class="n">square</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">square</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">printed</span><span class="w"></span>

<span class="n">to</span><span class="w"> </span><span class="n">flower</span><span class="w"> </span><span class="o">:</span><span class="n">size</span><span class="w"></span>
<span class="w">  </span><span class="n">repeat</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="n">rt</span><span class="w"> </span><span class="mi">72</span><span class="w"></span>
<span class="w">    </span><span class="n">square</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="n">end</span><span class="w"></span>

<span class="n">flower</span><span class="w"> </span><span class="mi">50</span><span class="w"></span>
<span class="p">;</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">flower</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">made</span><span class="p">,</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">squares</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="mi">50</span><span class="w"></span>
</code></pre></div>

<p>That is, when you reference the variable <code>:size</code>, it doesn&#8217;t look locally, it doesn&#8217;t even look globally, rather it looks back through the&nbsp;callstack.</p>
<p>This can be very hard to understand (why does <code>flower</code> even take an argument?), but Logo isn&#8217;t a language written for&nbsp;maintainability.</p>
<p>That said, dynamic scope can be the right thing, and it&#8217;s widely simulated. Print is a common case,&nbsp;like:</p>
<div class="highlight"><pre><span></span><code><span class="n">old_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">run_some_function</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_stdout</span>
</code></pre></div>

<p>But instead of using any formal reference to dynamic scope, we&#8217;re temporarily modifying global objects. And there&#8217;s lots of <a href="https://docs.python.org/3/library/threading.html#thread-local-data">caveats</a>, even more so with async (incidentally <a href="https://github.com/python-trio/trio">Trio</a> attempts to address&nbsp;this).</p>
<p>What dynamic scoping addresses is <em>passing data through</em>. You could change the definition of <code>run_some_function()</code> to <code>run_some_function(output_fp=sys.stdout)</code>, and then you wouldn&#8217;t need all this. But then everything <code>run_some_function()</code> calls has to also take that argument, even if you don&#8217;t know if it <em>needs</em> that argument. And then you either give everything in your program a bunch of seemingly dumb arguments, create a <a href="https://en.wikipedia.org/wiki/God_object">God Object</a>, or you skip the whole&nbsp;thing.</p>
<p>There&#8217;s lots of surprisingly <a href="http://wiki.c2.com/?ContextObjectsAreEvil">moralistic arguments</a> about these choices. My personal take is that the moralizing is a symptom of a lack of formalization around real use cases: if it was a genuinely bad idea the moralizing wouldn&#8217;t be necessary, but because languages provide so little guidance it can be perilous to roll your own&nbsp;solutions.</p>
<h2>Dynamic Scoping to get values in <em>and</em>&nbsp;out</h2>
<p>I have always looked at dynamic scoping as a way to create a bounded environment for code, a way of giving code a context. But I realize much of the time that&#8217;s just scaffolding to get values <em>out</em>.</p>
<p>The print example makes this clear: the only purpose of changing <code>sys.stdout</code> is to get out what was printed during the function call. The replacement <code>sys.stdout</code> isn&#8217;t really&nbsp;&#8220;input&#8221;.</p>
<p>The question then: how do you get a return value from a function you yourself did not call? The answer to that is what I&#8217;ll call &#8220;dynamically scoped return&#8221;: the exchange across the call stack. It&#8217;s &#8220;dynamic&#8221; because the call stack is always&nbsp;dynamic:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run_some_function</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">something_is_true</span><span class="p">():</span>
        <span class="n">run_other_function</span><span class="p">()</span>
</code></pre></div>

<p>Will <code>run_other_function()</code> be called?  Neither static typing nor pure functional programming offers any additional insight, you just have to execute it and find out at runtime. That&#8217;s the &#8220;dynamic&#8221; part. The scope is what you are capturing, a function call, or perhaps in Trio it would be scoped to a <a href="https://trio.readthedocs.io/en/latest/reference-core.html#nurseries-and-spawning">nursery</a>.</p>
<p>Of course given the dynamic semantics, you should be prepared for a plurality of return&nbsp;values.</p>
<h2>Dynamic returns and&nbsp;exceptions</h2>
<p>Another case where you might use this technique is authorization: is the user (aka <a href="https://en.wikipedia.org/wiki/Principal_(computer_security)">principal</a> allowed to do everything? This is a common use case for dynamic input (the current user), but the output is often some NotAuthorized&nbsp;exception.</p>
<p>People often object to these kinds of exceptions, because they are unexceptional: a user trying to do something they shouldn&#8217;t is&nbsp;normal.</p>
<p>The exception has two nice properties: it can happen anywhere, including several function calls deep, and it halts further execution. How many of those can be turned into a dynamic return? Should immediate-termination be a feature of dynamic&nbsp;returns?</p>
<h2>How many side effects are dynamic&nbsp;returns?</h2>
<p>As I think about this, I wonder: how many side effects in programming are due to a lack of dynamic&nbsp;returns?</p>
<p>In many cases the simplest way to remove side effects is just to have&nbsp;promises:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_stuff</span><span class="p">():</span>
    <span class="n">filesystem</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="s2">&quot;some/path.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;some text&quot;</span><span class="p">);</span>

<span class="k">with</span> <span class="n">filesystem</span><span class="o">.</span><span class="n">context</span><span class="p">()</span> <span class="k">as</span> <span class="n">fs</span><span class="p">:</span>
    <span class="n">do_stuff</span><span class="p">()</span>
    <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>
</code></pre></div>

<p>Now it&#8217;s become something that looks like a transaction or a command&nbsp;queue.</p>
<h2>Does the language need first-class&nbsp;support?</h2>
<p>Is the Python context manager enough (caveats&nbsp;aside)?</p>
<p>In some sense, absolutely: nothing I&#8217;m describing is something that is impossible now, and it&#8217;s even normal in some&nbsp;environments.</p>
<p>The caveats – and future yet-to-be-seen caveats – do signal something of a problem. When a concept is ad hoc then other people won&#8217;t account for it in their systems. It took a while to get <a href="https://docs.python.org/3/library/threading.html#thread-local-data">threading.local</a> in Python, and it&#8217;s still a very low-level tool. Asyncio does not account for this, though Trio attempts&nbsp;to.</p>
<p>Existing approaches also all rely on side&nbsp;effects.</p>
<p>There was a time that people implemented functions like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p">$</span><span class="nv">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;How many items?&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nv">GOSUB</span><span class="w"> </span><span class="nv">input_number</span><span class="w"></span>
<span class="w">  </span><span class="nv">number_of_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">x</span><span class="w"></span>

<span class="nv">input_number</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="nv">PRINT</span><span class="w"> </span><span class="nv">query</span><span class="p">$</span><span class="w"></span>
<span class="w">  </span><span class="nv">INPUT</span><span class="w"> </span><span class="nv">x</span><span class="p">$</span><span class="w"></span>
<span class="w">  </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">VAL</span><span class="p">(</span><span class="nv">x</span><span class="p">$)</span><span class="w"></span>
<span class="w">  </span><span class="nv">IF</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">THEN</span><span class="w"> </span><span class="nv">GOTO</span><span class="w"> </span><span class="o">:</span><span class="nv">input_number</span><span class="w"></span>
<span class="w">  </span><span class="nv">RETURN</span><span class="w"></span>
</code></pre></div>

<p>Instead of return values there were just conventions around global variables. The patterns will exist even if the language doesn&#8217;t support them. But they fail in all kinds of&nbsp;ways.</p>
<h2>Is a function call the right&nbsp;scope?</h2>
<p>Both with dynamic scoping and my proposed dynamically scoped returns I&#8217;ve mostly assumed that the scope is a function call. Everything that happens during that function call gets the dynamically scoped input variables, and everything that happens during the function call produces a group of dynamic&nbsp;returns.</p>
<p>Async programming styles immediately demonstrate a problem here. What is &#8220;during&#8221;? Should dynamic values be part of a closure? That seems okay for input, but means there&#8217;s no finality to the return value, some closure might try to emit new values at any&nbsp;time.</p>
<p>In the old days network services would use spawned processes to offer some of this isolation, though with a variety of scaling problems. Are things like <a href="https://en.wikipedia.org/wiki/Actor_model">Actors</a> appropriate? Is the Trio nursery a good abstraction? (I don&#8217;t <em>think</em> it&#8217;s really equivalent to an Actor.) Database transactions are another obvious example of this pattern, and use similar&nbsp;patterns.</p>
<h2>Other&nbsp;questions</h2>
<ol>
<li>How should these things&nbsp;nest?</li>
<li>If you are capturing a dynamic return, and somewhere further down someone else captures the same dynamic return, does the subroutine have to manually pass values up (if it chooses to do&nbsp;so)?</li>
<li>Can you monitor and raise exceptions on some or any return&nbsp;values?</li>
<li>Can you stream values? E.g., if I &#8220;capture&#8221; print statements, but want to watch and immediately pass them up to the standard stdout, can I do&nbsp;that?</li>
<li>Is streaming even an <span class="caps">OK</span> thing to do? It&#8217;s like a thing that can&#8217;t be undone, unlike other return values which are atomic (either they return, or an exception is raised, but not&nbsp;both).</li>
<li>Is dynamic input and dynamic output the same concept? Should they all be packaged together, distinguished only by&nbsp;usage?</li>
<li>What reflection should be&nbsp;available?</li>
<li>What are illegal usage patterns? Is it possible to store the returning object and use it&nbsp;later?</li>
<li>How is this different from pubsub&nbsp;patterns?</li>
<li>Is there any special approach to registering a global/fallback&nbsp;handler?</li>
</ol></div>
        <!-- /.entry-content -->
    </article>
</section>
        <section id="extras" class="body">
                <div class="links">
                  <h2><a href="https://ianbicking.org">here</a></h2>
                  <ul>
                    <li><a href="/blog/">blog</a></li>
                    <li><a href="/projects.html">projects</a></li>
                    <li><a href="https://ianbicking.org/archives.html">archives</a> &amp; <a href="https://ianbicking.org/categories.html">categories</a></li>
                    <li><a href="https://ianbicking.org/category/javascript.html">category: javascript</a></li>
                    <li><a href="https://ianbicking.org/category/misc.html">category: misc</a></li>
                    <li><a href="https://ianbicking.org/category/mozilla.html">category: mozilla</a></li>
                    </ul>
                </div>
                <div class="social">
                        <h2>elsewhere</h2>
                        <ul>
                            <li><a href="https://ianbicking.org/feeds/atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://twitter.com/ianbicking">@ianbicking</a></li>
                            <li><a href="https://hachyderm.io/@ianbicking">@ianbicking@hachyderm.io</a></li>
                            <li><a href="https://github.com/ianb">Github</a></li>
                        </ul>
                </div><!-- /.social -->
                <div class="archives">
                  <h2><a href="https://ianbicking.org/blog/">recent posts</a></h2>
                  <ul>
                    <li><a href="https://ianbicking.org/blog/2020/11/firefox-was-always-enough.html">Firefox Was Always&nbsp;Enough</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/project-ideas-2020.html">Project ideas for (what&#8217;s left of)&nbsp;2020</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/09/a-history-of-projects.html">A History Of&nbsp;Projects</a></li>
                    <li><a href="https://ianbicking.org/blog/2020/08/thoughts-on-voice-interfaces.html">Thoughts on Voice&nbsp;Interfaces</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/07/kling-axes-of-politics-technocrats.html">Kling&#8217;s Axes of Politics, and the&nbsp;Technocrats</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/04/users-want-control-is-a-shrug.html"><span class="dquo">&#8220;</span>Users want control&#8221; is a shoulder&nbsp;shrug</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/03/open-source-doesnt-make-money-by-design.html">Open Source Doesn&#8217;t Make Money Because It Isn&#8217;t Designed To Make&nbsp;Money</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/03/firefox-experiments-i-would-have-liked.html">The Firefox Experiments I Would Have Liked To&nbsp;Try</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/01/overengaged-knowledge-worker.html">The Over-engaged Knowledge&nbsp;Worker</a></li>
                    <li><a href="https://ianbicking.org/blog/2019/01/we-need-open-hosting-platforms.html">We Need Open Hosting&nbsp;Platforms</a></li>
                  </ul>
                </div><!-- /.archives -->

                <div class="widgets">
                  <h2><a href="https://twitter.com/ianbicking">tweets</a></h2>
                  <a class="twitter-timeline" width="230" height="500" href="https://twitter.com/ianbicking" data-widget-id="319849964417187842" data-link-color="#aaae94">Tweets by @ianbicking</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                </div><!-- /.widgets -->

        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
          This is the personal site of <a href="/">Ian Bicking</a>.  The opinions expressed here are my own.
        </footer><!-- /#contentinfo -->

<script src="/theme/instantclick.min.js"></script>
    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-2442258-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>
        </div><!-- /#main-container -->
        </div><!-- /#main-wrapper2 -->
        </div><!-- /#main-wrapper1 -->
</body>
</html>